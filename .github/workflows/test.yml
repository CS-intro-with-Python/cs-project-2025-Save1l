name: Docker Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Build Docker image
      run: docker build -t flask-server .
    
    - name: Run Docker container
      run: |
        docker run -d -p 5000:5000 --name test-server flask-server
        echo "Container started, waiting for server to be ready..."
        sleep 5
    
    - name: Check if container is running
      run: docker ps -a
    
    - name: Check container logs
      run: docker logs test-server
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install client dependencies
      run: |
        pip install requests
    
    - name: Run client test
      run: |
        python client.py
    
    - name: Stop and remove container
      if: always()
      run: |
        docker stop test-server || true
        docker rm test-server || true
